diff --git a/auto/cc/name b/auto/cc/name
index ded93f5bc..d6ab27a6a 100644
--- a/auto/cc/name
+++ b/auto/cc/name
@@ -7,7 +7,7 @@ if [ "$NGX_PLATFORM" != win32 ]; then
 
     ngx_feature="C compiler"
     ngx_feature_name=
-    ngx_feature_run=yes
+    ngx_feature_run=no
     ngx_feature_incs=
     ngx_feature_path=
     ngx_feature_libs=
diff --git a/auto/lib/libatomic/conf b/auto/lib/libatomic/conf
index 8c8cb438b..fe6e924cd 100644
--- a/auto/lib/libatomic/conf
+++ b/auto/lib/libatomic/conf
@@ -6,9 +6,11 @@
 if [ $NGX_LIBATOMIC != YES ]; then
 
     have=NGX_HAVE_LIBATOMIC . auto/have
-    CORE_INCS="$CORE_INCS $NGX_LIBATOMIC/src"
-    LINK_DEPS="$LINK_DEPS $NGX_LIBATOMIC/src/libatomic_ops.a"
-    CORE_LIBS="$CORE_LIBS $NGX_LIBATOMIC/src/libatomic_ops.a"
+    CORE_INCS="$CORE_INCS $NGX_LIBATOMIC/include"
+    LINK_DEPS="$LINK_DEPS $NGX_LIBATOMIC/lib/libatomic_ops.a"
+    CORE_LIBS="$CORE_LIBS $NGX_LIBATOMIC/lib/libatomic_ops.a"
+    NGX_LIBATOMIC_ROOTFS=$NGX_LIBATOMIC
+    NGX_LIBATOMIC=ROOTFS
 
 else
 
diff --git a/auto/lib/make b/auto/lib/make
index b64e32908..24d48570a 100644
--- a/auto/lib/make
+++ b/auto/lib/make
@@ -3,19 +3,19 @@
 # Copyright (C) Nginx, Inc.
 
 
-if [ $PCRE != NONE -a $PCRE != NO -a $PCRE != YES ]; then
+if [ $PCRE != NONE -a $PCRE != NO -a $PCRE != YES -a $PCRE != ROOTFS ]; then
     . auto/lib/pcre/make
 fi
 
-if [ $OPENSSL != NONE -a $OPENSSL != NO -a $OPENSSL != YES ]; then
+if [ $OPENSSL != NONE -a $OPENSSL != NO -a $OPENSSL != YES -a $OPENSSL != ROOTFS ]; then
     . auto/lib/openssl/make
 fi
 
-if [ $ZLIB != NONE -a $ZLIB != NO -a $ZLIB != YES ]; then
+if [ $ZLIB != NONE -a $ZLIB != NO -a $ZLIB != YES -a $ZLIB != ROOTFS ]; then
     . auto/lib/zlib/make
 fi
 
-if [ $NGX_LIBATOMIC != NO -a $NGX_LIBATOMIC != YES ]; then
+if [ $NGX_LIBATOMIC != NO -a $NGX_LIBATOMIC != YES -a $NGX_LIBATOMIC != ROOTFS ]; then
     . auto/lib/libatomic/make
 fi
 
diff --git a/auto/lib/openssl/conf b/auto/lib/openssl/conf
index fdf430dff..761483b50 100644
--- a/auto/lib/openssl/conf
+++ b/auto/lib/openssl/conf
@@ -40,12 +40,15 @@ if [ $OPENSSL != NONE ]; then
         ;;
 
         *)
-            CORE_INCS="$CORE_INCS $OPENSSL/.openssl/include"
-            CORE_DEPS="$CORE_DEPS $OPENSSL/.openssl/include/openssl/ssl.h"
-            CORE_LIBS="$CORE_LIBS $OPENSSL/.openssl/lib/libssl.a"
-            CORE_LIBS="$CORE_LIBS $OPENSSL/.openssl/lib/libcrypto.a"
+            CORE_INCS="$CORE_INCS $OPENSSL/include"
+            CORE_DEPS="$CORE_DEPS $OPENSSL/include/openssl/ssl.h"
+            # CORE_LIBS="$CORE_LIBS $OPENSSL/lib/libssl.a"
+            # CORE_LIBS="$CORE_LIBS $OPENSSL/lib/libcrypto.a"
+            CORE_LIBS="$CORE_LIBS -L $OPENSSL/lib -lcrypto -lssl"
             CORE_LIBS="$CORE_LIBS $NGX_LIBDL"
             CORE_LIBS="$CORE_LIBS $NGX_LIBPTHREAD"
+            OPENSSL_ROOTFS=$OPENSSL
+            OPENSSL=ROOTFS
 
             if [ "$NGX_PLATFORM" = win32 ]; then
                 CORE_LIBS="$CORE_LIBS -lgdi32 -lcrypt32 -lws2_32"
diff --git a/auto/lib/pcre/conf b/auto/lib/pcre/conf
index cdf1809f5..d3a7dc0c1 100644
--- a/auto/lib/pcre/conf
+++ b/auto/lib/pcre/conf
@@ -43,8 +43,8 @@ if [ $PCRE != NONE ]; then
             have=PCRE_STATIC . auto/have
         fi
 
-        CORE_INCS="$CORE_INCS $PCRE"
-        CORE_DEPS="$CORE_DEPS $PCRE/pcre.h"
+        CORE_INCS="$CORE_INCS $PCRE/include"
+        CORE_DEPS="$CORE_DEPS $PCRE/include/pcre.h"
 
         case "$NGX_CC_NAME" in
 
@@ -54,8 +54,11 @@ if [ $PCRE != NONE ]; then
             ;;
 
             *)
-                LINK_DEPS="$LINK_DEPS $PCRE/.libs/libpcre.a"
-                CORE_LIBS="$CORE_LIBS $PCRE/.libs/libpcre.a"
+                # LINK_DEPS="$LINK_DEPS $PCRE/lib/libpcre.a"
+                # CORE_LIBS="$CORE_LIBS $PCRE/lib/libpcre.a"
+                CORE_LIBS="$CORE_LIBS -L $PCRE/lib -lpcre"
+                PCRE_ROOTFS=$PCRE
+                PCRE=ROOTFS
             ;;
 
         esac
diff --git a/auto/lib/zlib/conf b/auto/lib/zlib/conf
index 239592e3c..a32388abf 100644
--- a/auto/lib/zlib/conf
+++ b/auto/lib/zlib/conf
@@ -4,7 +4,7 @@
 
 
 if [ $ZLIB != NONE ]; then
-    CORE_INCS="$CORE_INCS $ZLIB"
+    CORE_INCS="$CORE_INCS $ZLIB/include"
 
     case "$NGX_CC_NAME" in
 
@@ -33,9 +33,11 @@ if [ $ZLIB != NONE ]; then
 
         *)
             have=NGX_ZLIB . auto/have
-            LINK_DEPS="$LINK_DEPS $ZLIB/libz.a"
-            CORE_LIBS="$CORE_LIBS $ZLIB/libz.a"
-            #CORE_LIBS="$CORE_LIBS -L $ZLIB -lz"
+            # LINK_DEPS="$LINK_DEPS $ZLIB/lib/libz.a"
+            # CORE_LIBS="$CORE_LIBS $ZLIB/lib/libz.a"
+            CORE_LIBS="$CORE_LIBS -L $ZLIB/lib -lz"
+            ZLIB_ROOTFS=$ZLIB
+            ZLIB=ROOTFS
         ;;
 
     esac
diff --git a/auto/summary b/auto/summary
index b3c07eedc..28e646ea3 100644
--- a/auto/summary
+++ b/auto/summary
@@ -18,6 +18,7 @@ else
     case $PCRE in
         YES)   echo "  + using system $PCRE_LIBRARY library" ;;
         NONE)  echo "  + PCRE library is not used" ;;
+        ROOTFS)echo "  + using $PCRE_LIBRARY library from rootfs: $PCRE_ROOTFS" ;;
         *)     echo "  + using $PCRE_LIBRARY library: $PCRE" ;;
     esac
 fi
@@ -25,12 +26,14 @@ fi
 case $OPENSSL in
     YES)   echo "  + using system OpenSSL library" ;;
     NONE)  echo "  + OpenSSL library is not used" ;;
+    ROOTFS)echo "  + using OpenSSL library from rootfs: $OPENSSL_ROOTFS" ;;
     *)     echo "  + using OpenSSL library: $OPENSSL" ;;
 esac
 
 case $ZLIB in
     YES)   echo "  + using system zlib library" ;;
     NONE)  echo "  + zlib library is not used" ;;
+    ROOTFS)echo "  + using zlib library from rootfs: $ZLIB_ROOTFS" ;;
     *)     echo "  + using zlib library: $ZLIB" ;;
 esac
 
diff --git a/auto/types/sizeof b/auto/types/sizeof
index 480d8cfa4..52c7287a8 100644
--- a/auto/types/sizeof
+++ b/auto/types/sizeof
@@ -33,7 +33,7 @@ int main(void) {
 END
 
 
-ngx_test="$CC $CC_TEST_FLAGS $CC_AUX_FLAGS \
+ngx_test="gcc $CC_TEST_FLAGS $CC_AUX_FLAGS \
           -o $NGX_AUTOTEST $NGX_AUTOTEST.c $NGX_LD_OPT $ngx_feature_libs"
 
 eval "$ngx_test >> $NGX_AUTOCONF_ERR 2>&1"
diff --git a/auto/unix b/auto/unix
index f29e69c61..40e496fcf 100644
--- a/auto/unix
+++ b/auto/unix
@@ -881,7 +881,7 @@ ngx_feature_test='void *p; int  fd;
 
 ngx_feature="System V shared memory"
 ngx_feature_name="NGX_HAVE_SYSVSHM"
-ngx_feature_run=yes
+ngx_feature_run=no
 ngx_feature_incs="#include <sys/ipc.h>
                   #include <sys/shm.h>"
 ngx_feature_path=
